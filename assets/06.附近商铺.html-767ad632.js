import{_ as o,V as e,W as c,Y as n,Z as s,$ as p,X as a,F as l}from"./framework-a569e214.js";const u="/img/redis/image-20230204184107283.png",i="/img/redis/image-20230204184410736.png",r="/img/redis/image-20230204190302194.png",k={},d=a('<h2 id="_01-geo数据结构的基本用法" tabindex="-1"><a class="header-anchor" href="#_01-geo数据结构的基本用法" aria-hidden="true">#</a> 01.GEO数据结构的基本用法</h2><p>GEO就是Geolocation的简写形式，代表地理坐标。Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据。常见的命令有：</p><ul><li>GEOADD：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）。</li><li>GEODIST：计算指定的两个点之间的距离并返回。</li><li>GEOHASH：将指定member的坐标转为hash字符串形式并返回。</li><li>GEOPOS：返回指定member的坐标。</li><li>GEORADIUS：指定圆心、半径，找到该圆内包含的所有member，并按照与圆心之间的距离排序后返回。6.2以后已废弃。</li><li>GEOSEARCH：在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能。</li><li>GEOSEARCHSTORE：与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key。6.2.新功能。</li></ul><p>不同的版本命令可能有所不同，下面是Redis 5.0 windows的命令：</p><figure><img src="'+u+`" alt="image-20230204184107283" tabindex="0" loading="lazy"><figcaption>image-20230204184107283</figcaption></figure><h2 id="_02-导入店铺数据到geo" tabindex="-1"><a class="header-anchor" href="#_02-导入店铺数据到geo" aria-hidden="true">#</a> 02.导入店铺数据到GEO</h2><p>按照商户类型做分组，类型相同的商户作为同一组，以typeId为key存入同一个GEO集合中即可。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadShopData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 1.查询店铺信息</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> shopService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.店铺按typeId分组</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> list
            <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span><span class="token class-name">Shop</span><span class="token operator">::</span><span class="token function">getTypeId</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.分批完成写入Redis</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.1获取类型id</span>
        <span class="token class-name">Long</span> typeId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">SHOP_GEO_KEY</span> <span class="token operator">+</span> typeId<span class="token punctuation">;</span>
        <span class="token comment">// 3.2获取同类型的店铺集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> shopList <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> locations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>shopList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.3写入Redis</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span> shop <span class="token operator">:</span> shopList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span>
            locations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                    shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>shop<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> locations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看Redis中的数据：</p><figure><img src="`+i+'" alt="image-20230204184410736" tabindex="0" loading="lazy"><figcaption>image-20230204184410736</figcaption></figure><h2 id="_03-实现附近商户功能" tabindex="-1"><a class="header-anchor" href="#_03-实现附近商户功能" aria-hidden="true">#</a> 03.实现附近商户功能</h2><h3 id="接口设计" tabindex="-1"><a class="header-anchor" href="#接口设计" aria-hidden="true">#</a> 接口设计</h3>',12),m={href:"http://localhost:8080/api/shop/of/type?&typeId=1&current=1&x=120.149993&y=30.334229",target:"_blank",rel:"noopener noreferrer"},v=a(`<ul><li><p>请求地址：<code>/shop/of/type</code></p></li><li><p>请求方式：<code>GET</code></p></li><li><p>请求参数</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>typeId</td><td>商户类型id</td></tr><tr><td>current</td><td>页码</td></tr><tr><td>x</td><td>商户位置：经度</td></tr><tr><td>y</td><td>商户位置：维度</td></tr></tbody></table></li><li><p>响应格式</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;success&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;蔡馬洪涛烤肉·老北京铜锅涮羊肉&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;typeId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://p0.meituan.net/bbia/c1870d570e73accbc9fee90b48faca41195272.jpg,http://p0.meituan.net/mogu/397e40c28fc87715b3d5435710a9f88d706914.jpg,https://qcloud.dpfile.com/pc/MZTdRDqCZdbPDUO0Hk6lZENRKzpKRF7kavrkEI99OxqBZTzPfIxa5E33gBfGouhFuzFvxlbkWx5uwqY2qcjixFEuLYk00OmSS1IdNpm8K8sG4JN9RIm2mTKcbLtc2o2vmIU_8ZGOT1OjpJmLxG6urQ.jpg&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;area&quot;</span><span class="token operator">:</span> <span class="token string">&quot;拱宸桥/上塘&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;上塘路1035号（中国工商银行旁）&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">120.151505</span><span class="token punctuation">,</span>
            <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">30.333422</span><span class="token punctuation">,</span>
            <span class="token property">&quot;avgPrice&quot;</span><span class="token operator">:</span> <span class="token number">85</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sold&quot;</span><span class="token operator">:</span> <span class="token number">2160</span><span class="token punctuation">,</span>
            <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span> <span class="token number">1460</span><span class="token punctuation">,</span>
            <span class="token property">&quot;score&quot;</span><span class="token operator">:</span> <span class="token number">46</span><span class="token punctuation">,</span>
            <span class="token property">&quot;openHours&quot;</span><span class="token operator">:</span> <span class="token string">&quot;11:30-03:00&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-12-22T19:00:13&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-01-11T16:12:26&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;distance&quot;</span><span class="token operator">:</span> <span class="token number">170.4498</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;羊老三羊蝎子牛仔排北派炭火锅(运河上街店)&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;typeId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://p0.meituan.net/biztone/163160492_1624251899456.jpeg,https://img.meituan.net/msmerchant/e478eb16f7e31a7f8b29b5e3bab6de205500837.jpg,https://img.meituan.net/msmerchant/6173eb1d18b9d70ace7fdb3f2dd939662884857.jpg&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;area&quot;</span><span class="token operator">:</span> <span class="token string">&quot;运河上街&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;台州路2号运河上街购物中心F5&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">120.150598</span><span class="token punctuation">,</span>
            <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">30.325251</span><span class="token punctuation">,</span>
            <span class="token property">&quot;avgPrice&quot;</span><span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sold&quot;</span><span class="token operator">:</span> <span class="token number">2763</span><span class="token punctuation">,</span>
            <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span> <span class="token number">1363</span><span class="token punctuation">,</span>
            <span class="token property">&quot;score&quot;</span><span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span>
            <span class="token property">&quot;openHours&quot;</span><span class="token operator">:</span> <span class="token string">&quot;11:00-21:30&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-12-22T19:53:59&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-01-11T16:13:34&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;distance&quot;</span><span class="token operator">:</span> <span class="token number">1000.3119</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;浅草屋寿司（运河上街店）&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;typeId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img.meituan.net/msmerchant/cf3dff697bf7f6e11f4b79c4e7d989e4591290.jpg,https://img.meituan.net/msmerchant/0b463f545355c8d8f021eb2987dcd0c8567811.jpg,https://img.meituan.net/msmerchant/c3c2516939efaf36c4ccc64b0e629fad587907.jpg&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;area&quot;</span><span class="token operator">:</span> <span class="token string">&quot;运河上街&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;拱墅区金华路80号运河上街B1&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">120.150526</span><span class="token punctuation">,</span>
            <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">30.325231</span><span class="token punctuation">,</span>
            <span class="token property">&quot;avgPrice&quot;</span><span class="token operator">:</span> <span class="token number">88</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sold&quot;</span><span class="token operator">:</span> <span class="token number">2406</span><span class="token punctuation">,</span>
            <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span> <span class="token number">1206</span><span class="token punctuation">,</span>
            <span class="token property">&quot;score&quot;</span><span class="token operator">:</span> <span class="token number">46</span><span class="token punctuation">,</span>
            <span class="token property">&quot;openHours&quot;</span><span class="token operator">:</span> <span class="token string">&quot; 11:00-21:30&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-12-22T19:51:06&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-01-11T16:13:25&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;distance&quot;</span><span class="token operator">:</span> <span class="token number">1002.1991</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;新白鹿餐厅(运河上街店)&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;typeId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://p0.meituan.net/biztone/694233_1619500156517.jpeg,https://img.meituan.net/msmerchant/876ca8983f7395556eda9ceb064e6bc51840883.png,https://img.meituan.net/msmerchant/86a76ed53c28eff709a36099aefe28b51554088.png&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;area&quot;</span><span class="token operator">:</span> <span class="token string">&quot;运河上街&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;台州路2号运河上街购物中心F5&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">120.151954</span><span class="token punctuation">,</span>
            <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">30.32497</span><span class="token punctuation">,</span>
            <span class="token property">&quot;avgPrice&quot;</span><span class="token operator">:</span> <span class="token number">61</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sold&quot;</span><span class="token operator">:</span> <span class="token number">12035</span><span class="token punctuation">,</span>
            <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span> <span class="token number">8045</span><span class="token punctuation">,</span>
            <span class="token property">&quot;score&quot;</span><span class="token operator">:</span> <span class="token number">47</span><span class="token punctuation">,</span>
            <span class="token property">&quot;openHours&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10:30-21:00&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-12-22T19:10:05&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-01-11T16:12:42&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;distance&quot;</span><span class="token operator">:</span> <span class="token number">1046.9829</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;幸福里老北京涮锅（丝联店）&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;typeId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img.meituan.net/msmerchant/e71a2d0d693b3033c15522c43e03f09198239.jpg,https://img.meituan.net/msmerchant/9f8a966d60ffba00daf35458522273ca658239.jpg,https://img.meituan.net/msmerchant/ef9ca5ef6c05d381946fe4a9aa7d9808554502.jpg&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;area&quot;</span><span class="token operator">:</span> <span class="token string">&quot;拱宸桥/上塘&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;金华南路189号丝联166号&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">120.148603</span><span class="token punctuation">,</span>
            <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">30.318618</span><span class="token punctuation">,</span>
            <span class="token property">&quot;avgPrice&quot;</span><span class="token operator">:</span> <span class="token number">130</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sold&quot;</span><span class="token operator">:</span> <span class="token number">9531</span><span class="token punctuation">,</span>
            <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span> <span class="token number">7324</span><span class="token punctuation">,</span>
            <span class="token property">&quot;score&quot;</span><span class="token operator">:</span> <span class="token number">46</span><span class="token punctuation">,</span>
            <span class="token property">&quot;openHours&quot;</span><span class="token operator">:</span> <span class="token string">&quot;11:00-13:50,17:00-20:50&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-12-22T19:24:53&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-01-11T16:13:09&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;distance&quot;</span><span class="token operator">:</span> <span class="token number">1741.5767</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="实现" tabindex="-1"><a class="header-anchor" href="#实现" aria-hidden="true">#</a> 实现</h3><p><code>ShopController</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据商铺类型分页查询商铺信息
 * <span class="token keyword">@param</span> <span class="token parameter">typeId</span> 商铺类型
 * <span class="token keyword">@param</span> <span class="token parameter">current</span> 页码
 * <span class="token keyword">@return</span> 商铺列表
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/of/type&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryShopByType</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;typeId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> typeId<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;current&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> current<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> x<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> y
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> shopService<span class="token punctuation">.</span><span class="token function">queryShopByType</span><span class="token punctuation">(</span>typeId<span class="token punctuation">,</span> current<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),b={href:"https://gitee.com/overau/hm-dianping/blob/master/src/main/java/com/hmdp/service/impl/ShopServiceImpl.java",target:"_blank",rel:"noopener noreferrer"},q=a(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据店铺类型和地理坐标分页查询店铺信息
 *
 * <span class="token keyword">@param</span> <span class="token parameter">typeId</span>  店铺类型id
 * <span class="token keyword">@param</span> <span class="token parameter">current</span> 页码
 * <span class="token keyword">@param</span> <span class="token parameter">x</span>       x
 * <span class="token keyword">@param</span> <span class="token parameter">y</span>       y
 * <span class="token keyword">@return</span> R
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryShopByType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> typeId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> current<span class="token punctuation">,</span> <span class="token class-name">Double</span> x<span class="token punctuation">,</span> <span class="token class-name">Double</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.判断是否需要坐标查询</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> y <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不需要坐标查询，查询数据库</span>
        <span class="token comment">// 根据类型分页查询</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;type_id&quot;</span><span class="token punctuation">,</span> typeId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_PAGE_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回数据</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2.计算分页参数</span>
    <span class="token keyword">int</span> from <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_PAGE_SIZE</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> end <span class="token operator">=</span> current <span class="token operator">*</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_PAGE_SIZE</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.查询Redis，按照距离排序、分页 结果:shopId、distance</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">SHOP_GEO_KEY</span> <span class="token operator">+</span> typeId<span class="token punctuation">;</span>
    <span class="token class-name">GeoResults</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">radius</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Circle</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Distance</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">,</span> <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>DistanceUnit</span><span class="token punctuation">.</span><span class="token constant">METERS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoRadiusCommandArgs</span><span class="token punctuation">.</span><span class="token function">newGeoRadiusArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includeDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> results<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.解析id</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GeoResult</span><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> from<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 沒有下一页,结束</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.1截取from~end</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Distance</span><span class="token punctuation">&gt;</span></span> distanceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 4.2获取店铺id</span>
        <span class="token class-name">String</span> shopIdStr <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>shopIdStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.3获取店铺距离</span>
        <span class="token class-name">Distance</span> distance <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        distanceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>shopIdStr<span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.根据id查询Shop</span>
    <span class="token class-name">String</span> idStr <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> shops <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER BY FIELD(id,&quot;</span> <span class="token operator">+</span> idStr <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span> shop <span class="token operator">:</span> shops<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shop<span class="token punctuation">.</span><span class="token function">setDistance</span><span class="token punctuation">(</span>distanceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 6.返回</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果：</p><figure><img src="`+r+'" alt="image-20230204190302194" tabindex="0" loading="lazy"><figcaption>image-20230204190302194</figcaption></figure>',3);function g(y,f){const t=l("ExternalLinkIcon");return e(),c("div",null,[d,n("p",null,[s("完整请求URL："),n("a",m,[s("http://localhost:8080/api/shop/of/type?&typeId=1&current=1&x=120.149993&y=30.334229"),p(t)])]),v,n("p",null,[n("a",b,[s("ShopServiceImpl"),p(t)])]),q])}const S=o(k,[["render",g],["__file","06.附近商铺.html.vue"]]);export{S as default};
